<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment URL Investigation - BillMeNow</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            background-color: #f8f9fa;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Payment URL Investigation</h1>
        <p>This page investigates the exact URL construction and browser behavior that's causing the 404 error.</p>

        <div class="test-section">
            <h2>Test 1: URL Construction Methods</h2>
            <button onclick="testURLConstruction()">Test Different URL Methods</button>
            <div id="url-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>Test 2: Browser Network Behavior</h2>
            <button onclick="testNetworkBehavior()">Test Network Requests</button>
            <div id="network-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>Test 3: Exact Frontend Simulation</h2>
            <button onclick="simulateFrontendCall()">Simulate Frontend Call</button>
            <div id="frontend-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>Test 4: Cache Bypass</h2>
            <button onclick="testCacheBypass()">Test with Cache Bypass</button>
            <div id="cache-result" class="result"></div>
        </div>
    </div>

    <script>
        async function testURLConstruction() {
            const resultDiv = document.getElementById('url-result');
            resultDiv.textContent = 'üîÑ Testing URL construction methods...';

            try {
                const baseURL = window.location.origin;
                const methods = [
                    { name: 'Relative URL', url: '/api/payment/create-order' },
                    { name: 'Absolute URL', url: `${baseURL}/api/payment/create-order` },
                    { name: 'Full URL', url: 'https://billmenow.vercel.app/api/payment/create-order' },
                    { name: 'With trailing slash', url: '/api/payment/create-order/' },
                    { name: 'No leading slash', url: 'api/payment/create-order' }
                ];

                let results = `Current origin: ${window.location.origin}\nCurrent pathname: ${window.location.pathname}\n\n`;

                for (const method of methods) {
                    try {
                        const testResponse = await fetch(method.url, {
                            method: 'GET',
                            cache: 'no-cache'
                        });
                        
                        results += `${method.name}: ${method.url}\n`;
                        results += `  Status: ${testResponse.status}\n`;
                        results += `  OK: ${testResponse.ok}\n`;
                        results += `  Final URL: ${testResponse.url}\n\n`;
                        
                    } catch (error) {
                        results += `${method.name}: ${method.url}\n`;
                        results += `  Error: ${error.message}\n\n`;
                    }
                }

                resultDiv.textContent = results;
            } catch (error) {
                resultDiv.textContent = `‚ùå URL construction test failed: ${error.message}`;
            }
        }

        async function testNetworkBehavior() {
            const resultDiv = document.getElementById('network-result');
            resultDiv.textContent = 'üîÑ Testing network behavior...';

            try {
                const testData = {
                    amount: 1.01,
                    currency: 'INR',
                    invoiceId: '6847f01b66e984b6c488677a',
                    clientInfo: {
                        name: 'Test User',
                        email: 'test@example.com'
                    }
                };

                // Test with different fetch configurations
                const configs = [
                    { name: 'Default', options: {} },
                    { name: 'No Cache', options: { cache: 'no-cache' } },
                    { name: 'Force Cache', options: { cache: 'force-cache' } },
                    { name: 'Reload', options: { cache: 'reload' } }
                ];

                let results = 'Network behavior tests:\n\n';

                for (const config of configs) {
                    try {
                        const response = await fetch('/api/payment/create-order', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(testData),
                            ...config.options
                        });

                        results += `${config.name}:\n`;
                        results += `  Status: ${response.status}\n`;
                        results += `  Headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}\n`;
                        
                        if (response.ok) {
                            const data = await response.json();
                            results += `  Success: ${data.success}\n`;
                            results += `  Order ID: ${data.order?.id}\n`;
                        } else {
                            const errorText = await response.text();
                            results += `  Error: ${errorText}\n`;
                        }
                        results += '\n';

                    } catch (error) {
                        results += `${config.name}: Error - ${error.message}\n\n`;
                    }
                }

                resultDiv.textContent = results;
            } catch (error) {
                resultDiv.textContent = `‚ùå Network behavior test failed: ${error.message}`;
            }
        }

        async function simulateFrontendCall() {
            const resultDiv = document.getElementById('frontend-result');
            resultDiv.textContent = 'üîÑ Simulating exact frontend call...';

            try {
                // Simulate the exact same call as the frontend
                const invoice = {
                    _id: '6847f01b66e984b6c488677a',
                    total: 1.01,
                    client: {
                        name: 'Test User',
                        email: 'test@example.com'
                    }
                };

                console.log('üìù Preparing order request with data:', {
                    amount: invoice.total,
                    currency: 'INR',
                    invoiceId: invoice._id,
                    clientInfo: {
                        name: invoice.client?.name,
                        email: invoice.client?.email
                    }
                });

                const orderResponse = await fetch('/api/payment/create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Simulate auth header if available
                        ...(localStorage.getItem('token') && {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        })
                    },
                    body: JSON.stringify({
                        amount: invoice.total,
                        currency: 'INR',
                        invoiceId: invoice._id,
                        clientInfo: {
                            name: invoice.client?.name,
                            email: invoice.client?.email
                        }
                    })
                });

                console.log('üì° Order API response status:', orderResponse.status);
                console.log('üì° Order API response headers:', Object.fromEntries(orderResponse.headers.entries()));
                console.log('üì° Order API response ok:', orderResponse.ok);

                let results = `Frontend simulation results:\n\n`;
                results += `Request URL: ${orderResponse.url}\n`;
                results += `Response Status: ${orderResponse.status}\n`;
                results += `Response OK: ${orderResponse.ok}\n`;
                results += `Response Headers: ${JSON.stringify(Object.fromEntries(orderResponse.headers.entries()), null, 2)}\n\n`;

                if (!orderResponse.ok) {
                    const errorText = await orderResponse.text();
                    console.error('‚ùå Order API failed with status:', orderResponse.status);
                    console.error('‚ùå Order API error response:', errorText);
                    results += `Error Response: ${errorText}\n`;
                } else {
                    const orderData = await orderResponse.json();
                    console.log('üìã Order API response data:', orderData);
                    results += `Success Response: ${JSON.stringify(orderData, null, 2)}\n`;
                }

                resultDiv.textContent = results;
            } catch (error) {
                resultDiv.textContent = `‚ùå Frontend simulation failed: ${error.message}\nStack: ${error.stack}`;
            }
        }

        async function testCacheBypass() {
            const resultDiv = document.getElementById('cache-result');
            resultDiv.textContent = 'üîÑ Testing cache bypass methods...';

            try {
                const testData = {
                    amount: 1.01,
                    currency: 'INR',
                    invoiceId: '6847f01b66e984b6c488677a',
                    clientInfo: {
                        name: 'Test User',
                        email: 'test@example.com'
                    }
                };

                // Add timestamp to URL to bypass cache
                const timestamp = Date.now();
                const urlWithTimestamp = `/api/payment/create-order?t=${timestamp}`;

                const response = await fetch(urlWithTimestamp, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    body: JSON.stringify(testData),
                    cache: 'no-cache'
                });

                let results = `Cache bypass test results:\n\n`;
                results += `URL with timestamp: ${urlWithTimestamp}\n`;
                results += `Response Status: ${response.status}\n`;
                results += `Response OK: ${response.ok}\n`;
                results += `Final URL: ${response.url}\n\n`;

                if (response.ok) {
                    const data = await response.json();
                    results += `Success: ${data.success}\n`;
                    results += `Order ID: ${data.order?.id}\n`;
                } else {
                    const errorText = await response.text();
                    results += `Error: ${errorText}\n`;
                }

                resultDiv.textContent = results;
            } catch (error) {
                resultDiv.textContent = `‚ùå Cache bypass test failed: ${error.message}`;
            }
        }
    </script>
</body>
</html>
